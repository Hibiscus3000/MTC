import MTC/lab12/NVM;
import MTC/lab11/ast2str;

export
{
    vm2s(vmProgram : VMProgram) -> string;
}

vm2s(vmProgram)
{
    fold(vmProgram.labeledOperatorsSets,"",
        \acc,labeledOperatorsSet -> acc + labeledOperatorsSet2s(labeledOperatorsSet));
}

labeledOperatorsSet2s(labeledOperatorsSet)
{
    fold(labeledOperatorsSet.labeledOperators,"",
        \acc,labeledOperator -> acc + i2s(labeledOperatorsSet.label) + ": " + labeledOperator2s(labeledOperator) + "\n")
}

labeledOperator2s(labeledOperator)
{
    switch(labeledOperator : LabeledOperator)
    {
        LabeledAssignment(assignment,goto) : body2s(assignment,"") + " goto " + goto2s(goto);
        LabeledTest(relation,if_goto,else_goto) : 
            "if (" + relation2s(relation,0) + ") then " + goto2s(if_goto) + " else " + goto2s(else_goto);
    }
}

goto2s(goto)
{
    "{" + foldi(goto,"",\i,acc,gt -> acc + (if (i > 0) ", " else "") + i2s(gt)) + "}";
}